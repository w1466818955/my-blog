<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1.什么是事件循环? | Ygm的个人博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/my-blog/img/img.png">
    <meta name="description" content="不断学习，持续更新......">
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.04cd05af.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.c462eeac.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.b2c966ef.js" as="script"><link rel="preload" href="/my-blog/assets/js/21.caed3f3f.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.a66bbf3d.js"><link rel="prefetch" href="/my-blog/assets/js/11.cafc44d7.js"><link rel="prefetch" href="/my-blog/assets/js/12.a15ded9a.js"><link rel="prefetch" href="/my-blog/assets/js/13.4fa446f7.js"><link rel="prefetch" href="/my-blog/assets/js/14.cd6e102d.js"><link rel="prefetch" href="/my-blog/assets/js/15.3f7196b8.js"><link rel="prefetch" href="/my-blog/assets/js/16.b8364577.js"><link rel="prefetch" href="/my-blog/assets/js/17.af58ba6b.js"><link rel="prefetch" href="/my-blog/assets/js/18.f01db61c.js"><link rel="prefetch" href="/my-blog/assets/js/19.27fbfb51.js"><link rel="prefetch" href="/my-blog/assets/js/20.b34799ef.js"><link rel="prefetch" href="/my-blog/assets/js/22.d3cf4cd8.js"><link rel="prefetch" href="/my-blog/assets/js/23.ffad5780.js"><link rel="prefetch" href="/my-blog/assets/js/24.dadc9af2.js"><link rel="prefetch" href="/my-blog/assets/js/25.dc12f699.js"><link rel="prefetch" href="/my-blog/assets/js/26.a4f16c3e.js"><link rel="prefetch" href="/my-blog/assets/js/27.8e0fb178.js"><link rel="prefetch" href="/my-blog/assets/js/28.dcd2701c.js"><link rel="prefetch" href="/my-blog/assets/js/29.444f0b0a.js"><link rel="prefetch" href="/my-blog/assets/js/3.bfc32057.js"><link rel="prefetch" href="/my-blog/assets/js/30.9f09127b.js"><link rel="prefetch" href="/my-blog/assets/js/31.f026a46b.js"><link rel="prefetch" href="/my-blog/assets/js/4.261357d3.js"><link rel="prefetch" href="/my-blog/assets/js/5.0781132e.js"><link rel="prefetch" href="/my-blog/assets/js/6.4e261eb0.js"><link rel="prefetch" href="/my-blog/assets/js/7.7e641ac6.js"><link rel="prefetch" href="/my-blog/assets/js/8.70b93117.js"><link rel="prefetch" href="/my-blog/assets/js/9.4361fdfe.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.04cd05af.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><img src="/my-blog/img/img.png" alt="Ygm的个人博客" class="logo"> <span class="site-name can-hide">Ygm的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/html/one.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/css/one.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/js/one.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/TS/one.html" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/vue/one.html" class="nav-link">
  vue系列
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/react/one.html" class="nav-link">
  react系列
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/uniapp/one.html" class="nav-link">
  uniapp
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/question-bug/one.html" class="nav-link">
  项目问题bug
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/frontend/Python/one.html" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/my-blog/frontend/other/one.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/my-blog/message/" class="nav-link">
  留言板
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/frontend/html/one.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/css/one.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/js/one.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/TS/one.html" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/vue/one.html" class="nav-link">
  vue系列
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/react/one.html" class="nav-link">
  react系列
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/frontend/uniapp/one.html" class="nav-link">
  uniapp
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/question-bug/one.html" class="nav-link">
  项目问题bug
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/frontend/Python/one.html" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/my-blog/frontend/other/one.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/my-blog/message/" class="nav-link">
  留言板
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/frontend/js/one.html" class="sidebar-link">一、for...in和for...of的区别</a></li><li><a href="/my-blog/frontend/js/tow.html" class="sidebar-link">二、js中的Enum枚举类型数据</a></li><li><a href="/my-blog/frontend/js/three.html" aria-current="page" class="active sidebar-link">三、什么是事件循环?为什么会分为宏任务和微任务?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/frontend/js/three.html#_1-什么是事件循环" class="sidebar-link">1.什么是事件循环?</a></li><li class="sidebar-sub-header"><a href="/my-blog/frontend/js/three.html#_2-为什么会分为宏任务和微任务" class="sidebar-link">2.为什么会分为宏任务和微任务?</a></li><li class="sidebar-sub-header"><a href="/my-blog/frontend/js/three.html#_3-总结" class="sidebar-link">3.总结</a></li></ul></li><li><a href="/my-blog/frontend/js/four.html" class="sidebar-link">四、项目中所遇到的js封装</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>uniapp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-什么是事件循环"><a href="#_1-什么是事件循环" class="header-anchor">#</a> 1.什么是事件循环?</h2> <ul><li><p>js 引擎是单线程的，在一个时间点下只能去做一件事情，而 java 这种多线程语言，可以同事做几件事情。</p></li> <li><p>js 做任务的时候氛围同步和异步两种，所谓的“异步”，简单来说就是一个任务不是连续完成的，先执行第一段，等做好了准备，再回头执行第二段，第二段也被叫做回调；同步则是连贯完成的。</p></li> <li><p>读取文件、网络请求这种任务属于异步任务：花费时间很长，但中间的操作不需要 js 引擎自己完成，他只用等被人准备好了，把数据给他，他再继续执行回调部分。</p></li> <li><p>如果没有特殊处理，JS 引擎在执行异步任务时，应该是存在等待的，不去做任何其他事情。用一个图来展示这个过程，可以看出，在执行异步任务时有大量的空闲时间被浪费。</p></li> <li><p>实际上这是大多数多线程语言的处理办法。但对于 JS 这种单线程语言来说，这种长时间的空闲等待是不可接受的：遇到其他紧急任务，Java 可以再开一个线程去处理，JS 却只能忙等。</p></li> <li><p>所以采取了以下的“异步任务回调通知”模式：</p></li></ul> <p>（1）在等待异步任务准备的同时，JS 引擎去执行其他同步任务，等到异步任务准备好了，再去执行回调。这种模式的优势显而易见，完成相同的任务，花费的时间大大减少，这种方式也被叫做非阻塞式。</p> <p>（2）而实现这个“通知”的，正是事件循环，把异步任务的回调部分交给事件循环，等时机合适交还给 JS 线程执行。事件循环并不是 JavaScript 首创的，它是计算机的一种运行机制。</p> <p>（3）事件循环是由一个队列组成的，异步任务的回调遵循先进先出，在 JS 引擎空闲时会一轮一轮地被取出，所以被叫做循环。</p> <p>（4）根据队列中任务的不同，分为宏任务和微任务。</p> <h2 id="_2-为什么会分为宏任务和微任务"><a href="#_2-为什么会分为宏任务和微任务" class="header-anchor">#</a> 2.为什么会分为宏任务和微任务?</h2> <p>事件循环由宏任务和在执行任务期间产生的所有微任务组成。完成当下的宏任务之后，会立刻执行所有在此期间入队的微任务。</p> <p>这种设计是为了给紧急任务一个插队的机会，否则新入队的任务永远被放在队尾。区分了微任务和宏任务后，本轮循环中的微任务实际上就是在插队，这样微任务中所做的状态修改，在下一轮事件循环中也能得到同步。</p> <p><strong>常见的宏任务有：</strong> script（整体代码）/setTimout/setInterval/setImmediate(node 独有)/requestAnimationFrame(浏览器独有)/IO/UI render（浏览器独有）</p> <p><strong>常见的微任务有：</strong> process.nextTick(node 独有)/Promise.then()/Object.observe/MutationObserver</p> <ul><li><strong>宏任务 setTimeout 的误区</strong></li></ul> <p>setTimeout 的回调不一定在指定时间后能执行。而是在指定时间后，将回调函数放入事件循环的队列中。</p> <p>如果时间到了，JS 引擎还在执行同步任务，这个回调函数需要等待；如果当前事件循环的队列里还有其他回调，需要等其他回调执行完。</p> <p>另外，setTimeout 0ms 也不是立刻执行，它有一个默认最小时间，为 4ms。所以下面这段代码的输出结果不一定：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>因为取出第一个宏任务之前在执行全局 Script，如果这个时间大于 4ms，这时 setTimeout 的回调函数已经放入队列，就先执行 setTimeout；如果准备时间小于 4ms，就会先执行 setImmediate。</p> <ul><li><strong>浏览器的事件循环</strong></li></ul> <p>浏览器的事件循环由一个宏任务队列和多个微任务队列组成。</p> <p>首先，执行第一个宏任务：全局 Script 脚本。产生的宏任务和微任务进入各自的队列中。执行完 script 后，把当前的微任务队列清空，完成一次事件循环。</p> <p>接着再取出一个宏任务，同样把在此期间产生的回调入队。再把当前的微任务队列清空。以此往复。</p> <p>宏任务队列只有一个，而每一个宏任务都有一个自己的微任务队列，每轮循环都是由一个宏任务+多个微任务组成。</p> <p>下面的 Demo 展示了微任务的插队过程：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第一个回调函数：微任务1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第三个回调函数：宏任务2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第二个回调函数：宏任务1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第四个回调函数：微任务2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 第一个回调函数：微任务1</span>
<span class="token comment">// 第二个回调函数：宏任务1</span>
<span class="token comment">// 第四个回调函数：微任务2</span>
<span class="token comment">// 第三个回调函数：宏任务2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>打印的结果不是从 1 到 4，而是先执行第四个回调函数，再执行第三个，因为它是一个微任务，比第三个回调函数有更高优先级。</p> <ul><li><strong>Node 的事件循环</strong></li></ul> <p>node 的事件循环比浏览器复杂很多。由 6 个宏任务队列+6 个微任务队列组成。</p> <p>在一个宏任务队列全部执行完毕后，去清空一次微任务队列，然后到下一个等级的宏任务队列，以此往复。</p> <p>一个宏任务队列搭配一个微任务队列。六个等级的宏任务全部执行完成，才是一轮循环。</p> <p>其中需要关注的是：Timers、Poll、Check 阶段，因为我们所写的代码大多属于这三个阶段。</p> <p>Timers：定时器 setTimeout/setInterval；
Poll ：获取新的 I/O 事件, 例如操作读取文件等；
Check：setImmediate 回调函数在这里执行；
除此之外，node 端微任务也有优先级先后：</p> <p>（1）process.nextTick;</p> <p>（2）promise.then 等;</p> <p>清空微任务队列时，会先执行 process.nextTick，然后才是微任务队列中的其他。下面这段代码可以佐证浏览器和 node 的差异：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Script开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第一个回调函数，宏任务1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第四个回调函数，微任务2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第二个回调函数，宏任务2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第五个回调函数，微任务3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第三个回调函数，微任务1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Script结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>node端:
Script开始
Script结束
第三个回调函数，微任务1
第一个回调函数，宏任务1
第二个回调函数，宏任务2
第四个回调函数，微任务2
第五个回调函数，微任务3

浏览器:
Script开始
Script结束
第三个回调函数，微任务1
第一个回调函数，宏任务1
第四个回调函数，微任务2
第二个回调函数，宏任务2
第五个回调函数，微任务3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可以看出，在 node 端要等当前等级的所有宏任务完成，才能轮到微任务：第四个回调函数，微任务 2 在两个 setTimeout 完成后才打印。</p> <p>因为浏览器执行时是一个宏任务+一个微任务队列，而 node 是一整个宏任务队列+一个微任务队列。</p> <ul><li><strong>node11.x 前后版本差异</strong></li></ul> <p>node11.x 之前，其事件循环的规则就如上文所述：先取出完一整个宏任务队列中全部任务，然后执行一个微任务队列。</p> <p>但在 11.x 之后，node 端的事件循环变得和浏览器类似：先执行一个宏任务，然后是一个微任务队列。但依然保留了宏任务队列和微任务队列的优先级。可以用下面的 Demo 佐证：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Script开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;宏任务1（setTimeout)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;微任务promise2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;宏任务2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;宏任务3（setTimeout)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Script结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;微任务promise1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;微任务nextTick&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在 node11.x 之前运行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Script开始
Script结束
微任务nextTick
微任务promise1
宏任务1（setTimeout)
宏任务3（setTimeout)
微任务promise2
宏任务2（setImmediate)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 node11.x 之后运行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Script开始
Script结束
微任务nextTick
微任务promise1
宏任务1（setTimeout)
微任务promise2
宏任务3（setTimeout)
宏任务2（setImmediate)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以发现，在不同的 node 环境下：</p> <p>(1) 微任务队列中 process.nextTick 都有更高优先级，即使它后进入微任务队列，也会先打印微任务 nextTick 再微任务 promise1;</p> <p>(2) 宏任务 setTimeout 比 setImmediate 优先级更高，宏任务 2(setImmediate)是三个宏任务中最后打印的；</p> <p>(3) 在 node11.x 之前，微任务队列要等当前优先级的所有宏任务先执行完，在两个 setTimeout 之后才打印微任务 promise2；在 node11.x 之后，微任务队列只用等当前这一个宏任务先执行完。</p> <h2 id="_3-总结"><a href="#_3-总结" class="header-anchor">#</a> 3.总结</h2> <p>事件循环中的任务被分为宏任务和微任务，是为了给高优先级任务一个插队的机会，微任务比宏任务更具优先级。</p> <p>node 端的事件循环比浏览器更复杂，它的宏任务分为六个优先级，微任务分为两个优先级。node 端的执行规律是一个宏任务队列搭配一个微任务队列，宏任务队列中的宏任务会先执行，然后才是微任务队列中的微任务。</p> <p>而浏览器是一个单独的宏任务搭配一个微任务队列。但是在 node11 之后,node 和浏览器的规律趋同。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-blog/frontend/js/tow.html" class="prev">
        二、js中的Enum枚举类型数据
      </a></span> <span class="next"><a href="/my-blog/frontend/js/four.html">
        四、项目中所遇到的js封装
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my-blog/assets/js/app.c462eeac.js" defer></script><script src="/my-blog/assets/js/2.b2c966ef.js" defer></script><script src="/my-blog/assets/js/21.caed3f3f.js" defer></script>
  </body>
</html>
